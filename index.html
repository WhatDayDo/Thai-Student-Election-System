<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .tab-active { border-bottom: 3px solid #16a34a; color: #16a34a; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <nav class="bg-white shadow-sm sticky top-0 z-50 border-b">
        <div class="max-w-7xl mx-auto px-4 flex justify-between h-16 items-center">
            <div class="flex items-center gap-2 font-bold text-xl text-green-600">
                <i data-lucide="vote"></i> StudentVote | ASL
            </div>
            <div class="flex gap-4 items-center">
                <div id="user-display" class="hidden text-sm bg-green-50 text-green-700 px-4 py-2 rounded-full border border-green-100 font-bold"></div>
                <button onclick="enterAdminMode()" class="text-slate-400 hover:text-green-600"><i data-lucide="settings"></i></button>
            </div>
        </div>
        <div class="flex max-w-7xl mx-auto px-4 border-t">
            <button onclick="switchTab('vote')" id="tab-btn-vote" class="flex-1 py-4 tab-active">ลงคะแนนเสียง</button>
            <button onclick="switchTab('results')" id="tab-btn-results" class="flex-1 py-4 text-slate-500">สถิติผู้มาใช้สิทธิ์</button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div id="view-vote" class="tab-view">
            <section id="login-section" class="max-w-md mx-auto mt-10 bg-white p-10 rounded-3xl shadow-xl border text-center">
                <h2 class="text-2xl font-bold mb-6">เข้าสู่ระบบลงคะแนน</h2>
                <input type="text" id="student-id-input" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 text-center text-2xl font-bold tracking-[0.5em] outline-none focus:ring-2 focus:ring-green-500" placeholder="รหัส 4 หลัก" maxlength="4">
                <button onclick="handleLogin()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold hover:bg-green-700 transition-all text-lg shadow-lg">ตรวจสอบสิทธิ์</button>
            </section>
            <section id="voting-section" class="hidden">
                <h2 class="text-3xl font-bold text-center mb-8">บัตรลงคะแนนอิเล็กทรอนิกส์</h2>
                <div id="candidate-list" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </section>
        </div>

        <div id="view-results" class="tab-view hidden">
            <div class="grid lg:grid-cols-3 gap-8">
                <div class="bg-white p-8 rounded-3xl shadow-sm border text-center">
                    <h3 class="font-bold text-xl mb-6">ภาพรวมผู้มาใช้สิทธิ์</h3>
                    <div id="turnout-pie-chart"></div>
                    <div class="mt-6 p-4 bg-slate-50 rounded-2xl">
                        <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">นักเรียนทั้งหมด</p>
                        <span class="text-4xl font-black" id="total-students-count">0</span> คน
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white p-8 rounded-3xl shadow-sm border">
                    <h3 class="font-bold text-xl mb-6">ยอดผู้ใช้สิทธิ์แยกตามห้องเรียน (%)</h3>
                    <div id="room-bar-chart"></div>
                </div>
            </div>
            <div id="admin-results-section" class="hidden mt-12 p-8 bg-white rounded-3xl border-2 border-red-500 shadow-2xl">
                <h2 class="text-2xl font-bold text-red-600 mb-8 flex items-center gap-2"><i data-lucide="lock"></i> ผลคะแนนอย่างไม่เป็นทางการ (Admin)</h2>
                <div id="admin-vote-chart"></div>
            </div>
        </div>
    </main>

    <script>
        let currentUser = null;
        let pieChart, roomBarChart, adminVoteChart;

        $(document).ready(() => { 
            lucide.createIcons();
            initCharts();
            $('#student-id-input').focus();
            // รีเฟรชข้อมูลทุก 30 วินาที
            setInterval(updateTurnoutData, 30000);
        });

        function switchTab(tab) {
            $('.tab-view').addClass('hidden');
            $('#tab-btn-vote, #tab-btn-results').removeClass('tab-active').addClass('text-slate-500');
            if (tab === 'vote') {
                $('#view-vote').removeClass('hidden');
                $('#tab-btn-vote').addClass('tab-active').removeClass('text-slate-500');
            } else {
                $('#view-results').removeClass('hidden');
                $('#tab-btn-results').addClass('tab-active').removeClass('text-slate-500');
                updateTurnoutData();
            }
            lucide.createIcons();
        }

        function handleLogin() {
            const id = $('#student-id-input').val().trim();
            // ปรับตรวจสอบเงื่อนไขเป็นรหัส 4 หลัก
            if (id.length !== 4) return Swal.fire('ผิดพลาด', 'กรุณากรอกรหัส 4 หลัก', 'warning');
            
            Swal.fire({ title: 'กำลังตรวจสอบ...', didOpen: () => Swal.showLoading() });
            google.script.run.withSuccessHandler(res => {
                Swal.close();
                if (res && res.success) {
                    if (res.hasVoted) return Swal.fire('ใช้สิทธิ์แล้ว', 'คุณได้ลงคะแนนไปเรียบร้อยแล้ว', 'info');
                    currentUser = res;
                    $('#user-display').text(`คุณ${res.studentName} (${res.level}/${res.room})`).removeClass('hidden');
                    $('#login-section').hide();
                    loadCandidates();
                } else { Swal.fire('ไม่พบสิทธิ์', res ? res.message : 'ติดต่อ Server ไม่ได้', 'error'); }
            }).checkLogin(id);
        }

        function loadCandidates() {
            google.script.run.withSuccessHandler(candidates => {
                const list = $('#candidate-list').empty();
                candidates.forEach(c => {
                    list.append(`<div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                        <img src="${c.imageUrl}" class="w-full h-52 object-cover">
                        <div class="p-6"><h3 class="font-bold text-xl mb-4">เบอร์ ${c.id}: ${c.name}</h3>
                        <button onclick="confirmVote('${c.id}', '${c.name}')" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold shadow-lg">เลือกคนนี้</button></div></div>`);
                });
                list.append(`<div class="bg-slate-100 rounded-3xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center p-6 text-center">
                    <i data-lucide="user-x" class="text-slate-400 mb-4 w-12 h-12"></i><h3 class="font-bold text-xl mb-6">ไม่ประสงค์ลงคะแนน</h3>
                    <button onclick="confirmVote('0', 'ไม่ประสงค์ลงคะแนน')" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold">ยืนยันงดออกเสียง</button></div>`);
                $('#voting-section').fadeIn();
                lucide.createIcons();
            }).getCandidates();
        }

        function confirmVote(id, name) {
            Swal.fire({ title: 'ยืนยันการเลือก?', html: `คุณกำลังเลือก <b class="text-green-600">${name}</b>`, icon: 'question', showCancelButton: true, confirmButtonColor: '#16a34a' }).then(r => {
                if (r.isConfirmed) {
                    Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });
                    google.script.run.withSuccessHandler(msg => {
                        if (msg === "Success") {
                            Swal.fire({ title: 'สำเร็จ!', text: 'ขอบคุณที่มาใช้สิทธิ์ครับ', icon: 'success', timer: 2000, showConfirmButton: false }).then(() => resetApp());
                        } else { Swal.fire('Error', msg, 'error'); }
                    }).recordVote({ candidateId: id, studentId: currentUser.studentId, level: currentUser.level, room: currentUser.room });
                }
            });
        }

        function resetApp() {
            currentUser = null;
            $('#student-id-input').val('').focus();
            $('#user-display').addClass('hidden');
            $('#voting-section').hide();
            $('#login-section').show();
            $('#admin-results-section').hide();
            switchTab('vote');
        }

        function initCharts() {
            pieChart = new ApexCharts(document.querySelector("#turnout-pie-chart"), { chart: { type: 'donut', height: 300 }, series: [0, 0], labels: ['มาแล้ว', 'ยังไม่มา'], colors: ['#16a34a', '#f1f5f9'] });
            pieChart.render();
            roomBarChart = new ApexCharts(document.querySelector("#room-bar-chart"), { chart: { type: 'bar', height: 350 }, series: [{ data: [] }], xaxis: { categories: [] }, plotOptions: { bar: { horizontal: true } } });
            roomBarChart.render();
            adminVoteChart = new ApexCharts(document.querySelector("#admin-vote-chart"), { chart: { type: 'bar', height: 350 }, series: [{ name: 'คะแนน', data: [] }], xaxis: { categories: [] }, colors: ['#ef4444'] });
            adminVoteChart.render();
        }

        function updateTurnoutData() {
            google.script.run.withSuccessHandler(res => {
                if(!res || res.total === 0) return;
                const rooms = Object.keys(res.rooms);
                const p = rooms.map(k => Math.round((res.rooms[k].voted / res.rooms[k].total) * 100));
                $('#total-students-count').text(res.total);
                pieChart.updateSeries([res.voted, res.total - res.voted]);
                roomBarChart.updateOptions({ xaxis: { categories: rooms }, series: [{ name: 'ใช้สิทธิ์แล้ว (%)', data: p }] });
            }).getTurnoutStats();
        }

        function enterAdminMode() {
            Swal.fire({ title: 'Admin Login', input: 'password', showCancelButton: true }).then(r => {
                if (r.value) {
                    google.script.run.withSuccessHandler(ok => {
                        if (ok) {
                            switchTab('results');
                            $('#admin-results-section').fadeIn();
                            google.script.run.withSuccessHandler(sum => {
                                const ids = Object.keys(sum).sort((a,b)=>a-b);
                                const cats = ids.map(id => id == '0' ? 'งดออกเสียง' : 'เบอร์ ' + id);
                                const vals = ids.map(id => sum[id]);
                                adminVoteChart.updateOptions({ xaxis: { categories: cats }, series: [{ data: vals }] });
                            }).getAdminVoteSummary();
                        } else { Swal.fire('รหัสผิด', '', 'error'); }
                    }).verifyAdmin(r.value);
                }
            });
        }
    </script>
</body>
</html>
